$(function(){function e(e){this.$li=$("<li>").addClass("image").append($("<img>").prop("src",e)).append($("<input>").attr("type","button").attr("value","supprimer").addClass("button").addClass("delete").click(function(){var e=$(this).parent();e.next().remove(),e.remove()})),this.after=function(e){this.$li.insertAfter(e)}}function t(){this._$=$("<li>").addClass("adder"),this._previous=null,this._in=null,this._before=null,this.success=function(){},this.init=function(){var e=(new Date).getTime()/Math.random();this._$.append($("<input>").attr("type","file").attr("multiple","").attr("id",e).hide().change(function(){s(this,this.files)}).bind("dragenter",function(){return!1})).append($("<label>").text("+").addClass("add").attr("for",e).on("dragenter",function(e){$(this).addClass("dragging"),e.stopPropagation(),e.preventDefault()}).on("dragover",function(e){e.stopPropagation(),e.preventDefault()}).on("dragleave",function(){$(this).removeClass("dragging")}).on("drop",function(e){s(this,e.originalEvent.dataTransfer.files),e.stopPropagation(),e.preventDefault(),$(this).removeClass("dragging")})),this._in?this._$.appendTo(this._in):this._previous?this._$.insertAfter(this._previous):this._before&&this._$.insertBefore(this._before)}}function i(i){this._picture=new e(i),this._adder=new t,this.after=function(e){this._picture.after(e),this._adder._previous=this._picture.$li,this._adder.init()}}function n(e){var t=this;this._mode="edit",this._button=$(e),this.mode=function(e){return"edit"==e||"view"==e?("mode"!=this._mode&&this._button.trigger("click"),this):this._mode},this._button.click(function(){switch(t._mode){case"view":t._mode="edit",h.content.removeClass("view"),h.content.addClass("edit"),t._button.text("Mode édition"),h.toolbar.$.css("right","0px"),l.unset(),l=null;break;case"edit":if(h.images=$(".image"),0!=h.images.length){t._mode="view",h.content.removeClass("edit"),h.content.addClass("view"),t._button.text("Mode vue"),h.toolbar.$.css("right",($(window).width()-h.toolbar.$.width())/2+"px"),l=new d(h.show,h.images);break}alert("Il n'y a encore aucune image")}})}function r(){$(".gallery br").remove(),$(".adder").each(function(){var e=$(this);0!=e.next().length&&parseInt(e.offset().top+e.height()/2)!=parseInt(e.next().offset().top+e.next().height()/2)&&$("<br>").insertBefore(e)})}function s(e,t){for(var n,e=$(e),s=t.length,o=0;s>o;o++)if(n=t[o].name.split("."),n=n[n.length-1],-1!=c.indexOf(n)){var a=new FileReader;a.onload=function(){var t=new i(this.result);e.parent().hasClass("out-of-list")?t.after(h.gallery.children().last()):t.after(e.parent())},a.readAsDataURL(t[o])}h.gallery.show(),h.first.hide(),setTimeout(r,80)}function o(e,t){var i=this;this._mode=1,this._button=$(e),this.container=t,this.change=function(){},this._button.click(function(){switch(i._mode){case 2:i.mode(1,!0);break;case 1:i.mode(2,!0)}}),this.mode=function(e,t){switch(e){case 1:this.container.removeClass("duo"),this.container.addClass("solo"),1==t&&(i._mode=1,i._button.text("Une page"),i.change());break;case 2:this.container.removeClass("solo"),this.container.addClass("duo"),1==t&&(i._mode=2,i._button.text("Deux pages"),i.change())}return i._mode}}function a(e,t){this._image=$("<img>").attr("src",e),this._index=t,this._number=$("<p>").text(this._index+1).addClass("page-number"),this.$=$("<div>").addClass("page").append(this._image).append(this._number),this.show=function(){this.$.addClass("current")},this.hide=function(){this.$.removeClass("current")}}function d(e,t){var i=this;this.container=e,this.arrows=h.toolbar.arrows,this.arrows.left=$(this.arrows.left),this.arrows.right=$(this.arrows.right),this.mode=new o(h.toolbar.pageMode,this.container),this.mode.mode(1,!0),this.pages=[],this.currentIndex=0,this.unset=function(){this.container.empty()},this.refreshWidth=function(){this.container.css("left",($(window).width()-this.container.width())/2+"px"),this.container.css("max-height",$(window).height()-h.toolbar.$.height()-10+"px")},this.mode.change=function(){i.toIndex(i.currentIndex-i.currentIndex%this._mode),i.refreshWidth()},i.arrows.left.click(function(){i.currentIndex>0&&i.toIndex(2==i.mode.mode()?i.currentIndex-2:i.currentIndex-1)}),i.arrows.right.click(function(){i.currentIndex<i.pages.length-i.mode.mode()&&i.toIndex(2==i.mode.mode()?i.currentIndex+2:i.currentIndex+1)}),$(document).keydown(function(e){switch(e.keyCode){case 37:return i.arrows.left.trigger("click"),!1;case 39:return i.arrows.right.trigger("click"),!1}}),i.toIndex=function(e){i.pages[i.currentIndex].hide(),i.currentIndex=e,i.pages[i.currentIndex].show(i.mode.mode()),i.refreshWidth(),i.colorizeArrows()},this.colorizeArrows=function(){0==i.currentIndex?i.arrows.left.addClass("disabled"):i.arrows.left.removeClass("disabled"),i.currentIndex==i.pages.length-i.mode.mode()?i.arrows.right.addClass("disabled"):i.arrows.right.removeClass("disabled")};var n=0;t.each(function(){var e=new a($(this).children("img").attr("src"),n);i.pages.push(e),i.container.append(e.$),n++}),i.pages[this.currentIndex].show(),this.refreshWidth(),this.colorizeArrows()}$(window).resize(function(){$(".full-height").css("height",$(window).height()),null!=l&&l.refreshWidth(),r()}).resize();var h={content:$("#content"),gallery:$(".gallery ul"),first:$(".first ul"),viewer:$(".viewer"),show:$("#show .book"),toolbar:{$:$("#toolbar"),pageMode:$.find("#page-mode"),switchMode:$.find("#switch-mode"),arrows:{left:$.find("#prev-page"),right:$.find("#next-page")}},images:[]};h.gallery.hide();var l=(new n(h.toolbar.switchMode),null),c=["png","jpg","jpeg","gif"],u=new t;u._in=h.first,u.init(),u._$.addClass("out-of-list").find("label").html("Ajoutez un fichier<br/><span>Vous pouvez glisser-déposer des fichiers ou bien cliquer sur les boutons entourés de pointillés pour ajouter un fichier<span>");var u=new t;u._in=h.gallery,u.init(),h.gallery.sortable({placeholder:"sortable-placeholder",forcePlaceholderSize:!0,items:".image",tolerance:"pointer",start:function(){$(".delete").hide(),$(".adder:not(.out-of-list)").css("visibility","hidden")},stop:function(){$(".adder:not(.out-of-list)").remove();var e=new t;e._before=h.gallery.children().first(),e.init(),$(".image").each(function(){var e=new t;e._previous=this,e.init()}),$(".delete").show(),r()}})});